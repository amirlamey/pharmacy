{
 "add_total_row": 1,
 "columns": [],
 "creation": "2024-07-11 12:12:51.336996",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [
  {
   "fieldname": "frmdate",
   "fieldtype": "Datetime",
   "label": "From Date",
   "mandatory": 1,
   "wildcard_filter": 0
  },
  {
   "fieldname": "todate",
   "fieldtype": "Datetime",
   "label": "To Date",
   "mandatory": 1,
   "wildcard_filter": 0
  }
 ],
 "idx": 2,
 "is_standard": "Yes",
 "letterhead": null,
 "modified": "2024-08-25 17:02:25.078324",
 "modified_by": "Administrator",
 "module": "Pharmacy",
 "name": "Branches Monthly Valuation",
 "owner": "Administrator",
 "prepared_report": 0,
 "query": "WITH\r\n    internal_purchase AS (\r\n        SELECT\r\n            LPI.set_warehouse AS warehouse,\r\n            SUM(LPI.net_total) AS internal_purchase\r\n        FROM\r\n            `tabPurchase Invoice` LPI\r\n        WHERE\r\n            LPI.docstatus not in (0,2)\r\n            AND LPI.supplier = 'c1'\r\n            AND LPI.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LPI.set_warehouse\r\n    ),\r\n    drug_store_outgoing AS (\r\n        SELECT\r\n            LTE.to_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS outgoing_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.from_warehouse = 'Drugs Store  - WH'\r\n            AND LTE.docstatus not in (0,2)\r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.to_warehouse\r\n    ),\r\n    drug_store_incoming AS (\r\n        SELECT\r\n            LTE.from_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS incoming_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.to_warehouse = 'Drugs Store Receive  - WH'\r\n            AND LTE.docstatus not in (0,2)\r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.from_warehouse\r\n    ),\r\n    obour_store_outgoing AS (\r\n        SELECT\r\n            LTE.to_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS outgoing_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.from_warehouse = 'Obour Store - WH'\r\n            AND LTE.docstatus not in (0,2)\r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.to_warehouse\r\n    ),\r\n    obour_store_incoming AS (\r\n        SELECT\r\n            LTE.from_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS incoming_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.to_warehouse = 'Obour Receive - WH'\r\n            AND LTE.docstatus not in (0,2)\r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.from_warehouse\r\n    ),\r\n    cosmo_store_outgoing AS (\r\n        SELECT\r\n            LTE.to_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS outgoing_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.from_warehouse = 'Cosmo Store  - WH'\r\n            AND LTE.docstatus not in (0,2)\r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.to_warehouse\r\n    ),\r\n    cosmo_store_incoming AS (\r\n        SELECT\r\n            LTE.from_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS incoming_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.to_warehouse = 'Cosmo Store Receive - WH'\r\n            AND LTE.docstatus not in (0,2)\r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.from_warehouse\r\n    ),\r\n    taqsem_store_outgoing AS (\r\n        SELECT\r\n            LTE.to_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS outgoing_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.from_warehouse = 'Taqsem Store - WH'\r\n            AND LTE.docstatus not in (0,2)\r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.to_warehouse\r\n    ),\r\n    taqsem_store_incoming AS (\r\n        SELECT\r\n            LTE.from_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS incoming_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.to_warehouse = 'Taqsem Receive - WH'\r\n            AND LTE.docstatus not in (0,2)\r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.from_warehouse\r\n    ),\r\n    imported_store_outgoing AS (\r\n        SELECT\r\n            LTE.to_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS outgoing_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.from_warehouse in ('Other Store - WH','Extra Store - WH')\r\n            AND LTE.docstatus not in (0,2)\r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.to_warehouse\r\n    ),\r\n    imported_store_incoming AS (\r\n        SELECT\r\n            LTE.from_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS incoming_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.to_warehouse in ('Other Store - WH','Extra Store - WH')\r\n            AND LTE.docstatus not in (0,2)\r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.from_warehouse\r\n    ),\r\n    from_pharmacies AS (\r\n        SELECT\r\n            LTE.to_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS outgoing_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.from_warehouse IN \r\n                (SELECT name \r\n                FROM `tabWarehouse` \r\n                WHERE warehouse_type = '\u0641\u0631\u0639') \r\n            AND LTE.docstatus = 1\r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.to_warehouse\r\n    ),\r\n    to_pharmacies AS (\r\n        SELECT\r\n            LTE.from_warehouse AS warehouse,\r\n            SUM(LTE.total_outgoing_value) AS outgoing_value\r\n        FROM\r\n            `tabStock Entry` LTE\r\n        WHERE\r\n            LTE.to_warehouse IN \r\n                (SELECT default_in_transit_warehouse \r\n                FROM `tabWarehouse` \r\n                WHERE warehouse_type = '\u0641\u0631\u0639') \r\n            AND LTE.docstatus not in (0,2) \r\n            AND LTE.stock_entry_type = 'Material Transfer'\r\n            AND LTE.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LTE.from_warehouse\r\n    ),\r\n    net_sales AS (\r\n        SELECT\r\n            LSI.set_warehouse AS warehouse,\r\n            SUM(CASE WHEN LSI.is_return = 0 THEN LSI.net_total ELSE 0 END) AS sales,\r\n            SUM(CASE WHEN LSI.is_return = 1 THEN LSI.net_total ELSE 0 END) AS returns\r\n        FROM\r\n            `tabSales Invoice` LSI\r\n        WHERE\r\n            LSI.docstatus not in (0,2) \r\n            AND LSI.update_stock = 1\r\n            AND LSI.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LSI.set_warehouse\r\n    ),\r\n    delivery_sales AS (\r\n        SELECT\r\n            LSI.set_warehouse AS warehouse,\r\n            SUM(CASE WHEN LSI.is_return = 0 AND LSI.delivery_type = 'Home Delivery' THEN LSI.net_total ELSE 0 END) AS sales,\r\n            SUM(CASE WHEN LSI.is_return = 1 AND LSI.delivery_type = 'Home Delivery' THEN LSI.net_total ELSE 0 END) AS returns\r\n        FROM\r\n            `tabSales Invoice` LSI\r\n        WHERE\r\n            LSI.docstatus not in (0,2)\r\n            AND LSI.update_stock = 1 \r\n            AND LSI.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LSI.set_warehouse\r\n    ),\r\n    walkin_sales AS (\r\n        SELECT\r\n            LSI.set_warehouse AS warehouse,\r\n            SUM(CASE WHEN LSI.is_return = 0 AND LSI.delivery_type = 'Walk In' THEN LSI.net_total ELSE 0 END) AS sales,\r\n            SUM(CASE WHEN LSI.is_return = 1 AND LSI.delivery_type = 'Walk In' THEN LSI.net_total ELSE 0 END) AS returns\r\n        FROM\r\n            `tabSales Invoice` LSI\r\n        WHERE\r\n            LSI.docstatus not in (0,2)\r\n            AND LSI.update_stock = 1\r\n            AND LSI.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LSI.set_warehouse\r\n    ),\r\n    call_center_sales AS (\r\n        SELECT\r\n            LSI.set_warehouse AS warehouse,\r\n            SUM(CASE WHEN LSI.is_return = 0 AND LSI._order_type = 'Call Center' THEN LSI.net_total ELSE 0 END) AS sales,\r\n            SUM(CASE WHEN LSI.is_return = 1 AND LSI._order_type = 'Call Center' THEN LSI.net_total ELSE 0 END) AS returns\r\n        FROM\r\n            `tabSales Invoice` LSI\r\n        WHERE\r\n            LSI.docstatus not in (0,2)\r\n            AND LSI.update_stock = 1\r\n            AND LSI.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LSI.set_warehouse\r\n    ),\r\n    contract_sales AS (\r\n        SELECT\r\n            LSI.set_warehouse AS warehouse,\r\n            SUM(CASE WHEN LSI.is_return = 0 AND LSI.insurance_contract <> '' THEN LSI.net_total ELSE 0 END) AS sales,\r\n            SUM(CASE WHEN LSI.is_return = 1 AND LSI.insurance_contract <> '' THEN LSI.net_total ELSE 0 END) AS returns\r\n        FROM\r\n            `tabSales Invoice` LSI\r\n        WHERE\r\n            LSI.docstatus not in (0,2)\r\n            AND LSI.update_stock = 1\r\n            AND LSI.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LSI.set_warehouse\r\n    ),\r\n    cash_sales AS (\r\n        SELECT\r\n            LSI.set_warehouse AS warehouse,\r\n            SUM(CASE WHEN LSI.is_return = 0 AND LSI.custom_pos_cash = 1 THEN LSI.custom_pos_cash_collection ELSE 0 END) AS sales,\r\n            SUM(CASE WHEN LSI.is_return = 1 AND LSI.custom_pos_cash = 1 THEN LSI.custom_pos_cash_collection ELSE 0 END) AS returns\r\n        FROM\r\n            `tabSales Invoice` LSI\r\n        WHERE\r\n            LSI.docstatus not in (0,2)\r\n            AND LSI.update_stock = 1\r\n            AND LSI.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LSI.set_warehouse\r\n    ),\r\n    visa_sales AS (\r\n        SELECT\r\n            LSI.set_warehouse AS warehouse,\r\n            SUM(CASE WHEN LSI.is_return = 0 AND LSI.custom_pos_visa = 1 THEN LSI.custom_pos_visa_collection ELSE 0 END) AS sales,\r\n            SUM(CASE WHEN LSI.is_return = 1 AND LSI.custom_pos_visa = 1 THEN LSI.custom_pos_visa_collection ELSE 0 END) AS returns\r\n        FROM\r\n            `tabSales Invoice` LSI\r\n        WHERE\r\n            LSI.docstatus not in (0,2)\r\n            AND LSI.update_stock = 1\r\n            AND LSI.creation BETWEEN %(frmdate)s AND %(todate)s\r\n        GROUP BY\r\n            LSI.set_warehouse\r\n    )\r\nSELECT \r\n    LW.warehouse_name AS `Branch`,\r\n    COALESCE(ip.internal_purchase, 0) AS `Internal Purchase`,\r\n    COALESCE(dso.outgoing_value, 0) - COALESCE(dsi.incoming_value, 0) AS `Drug Store`,\r\n    COALESCE(oso.outgoing_value, 0) - COALESCE(osi.incoming_value, 0) AS `Obour Store`,\r\n    COALESCE(cso.outgoing_value, 0) - COALESCE(csi.incoming_value, 0) AS `Cosmo Store`,\r\n    COALESCE(tso.outgoing_value, 0) - COALESCE(tsi.incoming_value, 0) AS `Taqsem Store`,\r\n    COALESCE(iso.outgoing_value, 0) - COALESCE(isi.incoming_value, 0) AS `Imported Store`,\r\n    COALESCE(fp.outgoing_value, 0) AS `From Pharmacies`,\r\n    COALESCE(tp.outgoing_value, 0) AS `To Pharmacies`,\r\n    COALESCE(ns.sales, 0) - COALESCE(ns.returns, 0) AS `Net Sales`,\r\n    COALESCE(ds.sales, 0) - COALESCE(ds.returns, 0) AS `Delivery Sales`,\r\n    COALESCE(ws.sales, 0) - COALESCE(ws.returns, 0) AS `Walk In Sales`,\r\n    COALESCE(ccs.sales, 0) - COALESCE(ccs.returns, 0) AS `Call Center Sales`,\r\n    COALESCE(cs.sales, 0) - COALESCE(cs.returns, 0) AS `Contract Sales`,\r\n    COALESCE(cccs.sales, 0) - COALESCE(cccs.returns, 0) AS `Cash Sales`,\r\n    COALESCE(vvvs.sales, 0) - COALESCE(vvvs.returns, 0) AS `Visa Sales`\r\nFROM \r\n    `tabWarehouse` LW\r\nLEFT JOIN internal_purchase ip ON LW.name = ip.warehouse\r\nLEFT JOIN drug_store_outgoing dso ON LW.default_in_transit_warehouse = dso.warehouse\r\nLEFT JOIN drug_store_incoming dsi ON LW.name = dsi.warehouse\r\nLEFT JOIN obour_store_outgoing oso ON LW.default_in_transit_warehouse = oso.warehouse\r\nLEFT JOIN obour_store_incoming osi ON LW.name = osi.warehouse\r\nLEFT JOIN cosmo_store_outgoing cso ON LW.default_in_transit_warehouse = cso.warehouse\r\nLEFT JOIN cosmo_store_incoming csi ON LW.name = csi.warehouse\r\nLEFT JOIN taqsem_store_outgoing tso ON LW.default_in_transit_warehouse = tso.warehouse\r\nLEFT JOIN taqsem_store_incoming tsi ON LW.name = tsi.warehouse\r\nLEFT JOIN imported_store_outgoing iso ON LW.default_in_transit_warehouse = iso.warehouse\r\nLEFT JOIN imported_store_incoming isi ON LW.name = isi.warehouse\r\nLEFT JOIN from_pharmacies fp ON LW.default_in_transit_warehouse = fp.warehouse\r\nLEFT JOIN to_pharmacies tp ON LW.name = tp.warehouse\r\nLEFT JOIN net_sales ns ON LW.name = ns.warehouse\r\nLEFT JOIN delivery_sales ds ON LW.name = ds.warehouse\r\nLEFT JOIN walkin_sales ws ON LW.name = ws.warehouse\r\nLEFT JOIN call_center_sales ccs ON LW.name = ccs.warehouse\r\nLEFT JOIN contract_sales cs ON LW.name = cs.warehouse\r\nLEFT JOIN cash_sales cccs ON LW.name = cccs.warehouse\r\nLEFT JOIN visa_sales vvvs ON LW.name = vvvs.warehouse\r\nWHERE \r\n    LW.warehouse_type = '\u0641\u0631\u0639';\r\n",
 "ref_doctype": "Warehouse",
 "report_name": "Branches Monthly Valuation",
 "report_type": "Query Report",
 "roles": [
  {
   "role": "Manufacturing User"
  },
  {
   "role": "Manufacturing Manager"
  },
  {
   "role": "Stock Manager"
  },
  {
   "role": "Stock User"
  },
  {
   "role": "Supplier & Item & Purchase & Promotion"
  },
  {
   "role": "Branch Ghobrial"
  },
  {
   "role": "System Manager"
  },
  {
   "role": "Purchase Manager"
  }
 ]
}